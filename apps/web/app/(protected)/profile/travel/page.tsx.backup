import { Card } from '@ghxstship/ui';
import { Suspense } from 'react';
import { cookies } from 'next/headers';
import { createServerClient } from '@ghxstship/auth';
import { redirect } from 'next/navigation';
import TravelClient from './TravelClient';
import CreateTravelRecordClient from './CreateTravelRecordClient';

export const metadata = { title: 'Profile Â· Travel' };

export default async function TravelPage() {
  const cookieStore = cookies();
  const sb = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookies().get(name)?.value;
        },
      },
    }
  )cookieStore);

  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    redirect('/auth/sign-in');
  }

  const orgId = cookieStore.get('organization-id')?.value;
  if (!orgId) {
    redirect('/onboarding');
  }

  const { data: user } = await sb.auth.getUser();
  if (!user.user) {
    redirect('/auth/sign-in');
  }

  return (
    <div className="space-y-4">
      <Card title="Travel History">
        <div className="mb-3 flex items-center justify-end">
          <CreateTravelRecordClient orgId={orgId} userId={user.user.id} />
        </div>
        <div className="text-sm text-foreground/70">
          <Suspense fallback={<div>Loading...</div>}>
            <TravelClient orgId={orgId} userId={user.user.id} />
          </Suspense>
        </div>
      </Card>
    </div>
  );
}
